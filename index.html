<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calendrier AN ‚Äî Accueil</title>

  <link rel="icon" href="/logoalarm-192.png" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <meta name="theme-color" content="#0f172a" />

  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --accent:#2563eb; --text:#e5e7eb; }
    *{box-sizing:border-box}
    html, body {
      margin:0; padding:0; height:100%;
      font-family:system-ui,Segoe UI,Roboto,Ubuntu,sans-serif;
      background:#0b1220; color:var(--text); overflow-x:hidden;
    }
    a{text-decoration:none;color:inherit}
    .container{max-width:1100px;margin:0 auto;padding:16px}

    header{position:sticky;top:0;backdrop-filter:blur(8px);background:rgba(2,6,23,.7);border-bottom:1px solid rgba(148,163,184,.15);z-index:50}
    .nav{display:flex;align-items:center;justify-content:space-between;padding:10px 0}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand img{width:38px;height:38px;border-radius:10px}
    .menu{display:flex;gap:10px;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:12px;background:#0b1220;border:1px solid rgba(148,163,184,.25);cursor:pointer;color:var(--text);transition:.15s}
    .btn:hover{border-color:rgba(148,163,184,.45);transform:translateY(-1px)}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.danger{border-color:#ef4444;color:#fecaca}
    .hidden{display:none!important}
    main{min-height:65vh}
    .card{background:linear-gradient(180deg,rgba(17,24,39,.9),rgba(2,6,23,.7));border:1px solid rgba(148,163,184,.15);border-radius:18px;padding:24px;box-shadow:0 8px 25px rgba(0,0,0,.25)}
    footer{border-top:1px solid rgba(148,163,184,.15);padding:24px 0;color:var(--muted)}

    /* AUTH FIXE */
    .auth-wrap{position:fixed;inset:0;display:grid;place-items:center;background:#0b1220;overflow:hidden;z-index:40}
    .auth{width:90%;max-width:420px;background:var(--card);border-radius:16px;padding:24px;text-align:center;animation:fadeIn .4s ease-out}
    @keyframes fadeIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px;text-align:left}
    input{padding:12px 14px;border-radius:10px;border:1px solid rgba(148,163,184,.25);background:#0b1220;color:var(--text)}
    input:focus{border-color:var(--accent);outline:none}
    label{font-size:.9rem;color:#cbd5e1}
    .subtitle{color:var(--muted);font-size:.95rem;margin:10px 0 16px}
    .btn.full{width:100%}
    .sep{height:1px;background:rgba(148,163,184,.15);margin:16px 0}
    .link{border:none;background:none;color:#60a5fa;cursor:pointer;font-size:.95rem}
    .toast{position:fixed;bottom:16px;right:16px;padding:12px 14px;border-radius:10px;background:#111827;border:1px solid rgba(148,163,184,.2)}
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <div class="brand">
        <img src="/logoalarm-192.png" alt="AN">
        <span id="brandText">anassiri.com</span>
        <span id="auth-badge" class="hidden">D√©connect√©</span>
      </div>
      <nav id="navMenu" class="menu">
        <a href="#/" class="btn">Accueil</a>
        <a href="#/rendezvous" class="btn">Rendez-vous</a>
        <a href="#/profil" class="btn">Profil</a>
        <button id="logoutBtn" class="btn danger hidden" type="button">Se d√©connecter</button>
        <a href="#/auth" id="loginBtn" class="btn primary hidden">Se connecter</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- AUTH -->
    <section id="page-auth" class="auth-wrap hidden">
      <div class="auth">
        <img src="/logoalarm-192.png" alt="Logo Calendrier AN" style="width:80px;height:80px;border-radius:16px;margin-bottom:14px;">
        <h1>Cr√©er un compte</h1>
        <p class="subtitle">Inscris-toi puis <strong>v√©rifie ton email</strong> pour activer l‚Äôacc√®s.</p>

        <div class="field">
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="ex: vous@mail.com" autocomplete="email" />
        </div>
        <div class="field">
          <label for="password">Mot de passe</label>
          <input id="password" type="password" placeholder="Au moins 6 caract√®res" autocomplete="current-password" />
        </div>

        <button id="signup" class="btn primary full" type="button">S‚Äôinscrire</button>
        <div class="sep"></div>
        <p class="subtitle">D√©j√† inscrit ?</p>
        <button id="signin" class="link" type="button">Se connecter</button>
      </div>
    </section>

    <!-- ACCUEIL -->
    <section id="page-home" class="hidden">
      <div class="card">
        <h2>Bienvenue üëã</h2>
        <p>Tu es connect√©. Voici ton r√©sum√© de rendez-vous.</p>
      </div>
    </section>

    <!-- RDV -->
    <section id="page-rdv" class="hidden">
      <div class="card">
        <h2>Rendez-vous</h2>
        <p class="subtitle">Gestion compl√®te √† venir</p>
      </div>
    </section>

    <!-- PROFIL -->
    <section id="page-profil" class="hidden">
      <div class="card">
        <h2>Profil</h2>
        <p>Email : <span id="profil-email">‚Äî</span></p>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      ¬© <span id="year"></span> Calendrier AN ‚Äî Tous droits r√©serv√©s
    </div>
  </footer>

  <div id="toast" class="toast hidden"></div>

  <!-- Firebase Compat -->
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-auth-compat.js"></script>

  <script>
    // ===== S√©curit√© : catch erreurs JS globales =====
    window.addEventListener('error', (e)=>{
      console.error('Erreur globale:', e.error || e.message);
      try{ notify('Erreur: ' + (e.error?.message || e.message)); }catch{ alert('Erreur: ' + (e.error?.message || e.message)); }
    });

    // ===== Config Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyBfPvC5GtwKvG9TD7cLRo_WlPfifHhxfOU",
      authDomain: "productvues.firebaseapp.com",
      projectId: "productvues",
      storageBucket: "productvues.firebasestorage.app",
      messagingSenderId: "268641672431",
      appId: "1:268641672431:web:a4a5ec6d62fca218c5cf1a"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(err=>console.warn('setPersistence:',err?.message));

    // ===== DOM =====
    const pageAuth = document.getElementById('page-auth');
    const pageHome = document.getElementById('page-home');
    const pageRDV  = document.getElementById('page-rdv');
    const pageProfil = document.getElementById('page-profil');
    const navMenu = document.getElementById('navMenu');
    const brandText = document.getElementById('brandText');
    const badge = document.getElementById('auth-badge');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const emailEl = document.getElementById('email');
    const passEl  = document.getElementById('password');
    const toast   = document.getElementById('toast');
    document.getElementById('year').textContent = new Date().getFullYear();

    // ===== Router =====
    const routes = {
      '#/': () => show(auth.currentUser ? 'home' : 'auth'),
      '#/auth': () => show('auth'),
      '#/rendezvous': () => guard(() => show('rdv')),
      '#/profil': () => guard(() => show('profil'))
    };
    function guard(fn){ if(!auth.currentUser){ location.hash='#/auth'; notify('Connecte-toi'); return; } fn(); }
    function route(){ const h = location.hash || '#/'; (routes[h] || routes['#/'])(); }
    auth.onAuthStateChanged(()=>{ route(); });
    window.addEventListener('hashchange', route);

    // ===== Affichage =====
    function show(page){
      [pageAuth,pageHome,pageRDV,pageProfil].forEach(p=>p.classList.add('hidden'));
      if(page==='auth')   pageAuth.classList.remove('hidden');
      if(page==='home')   pageHome.classList.remove('hidden');
      if(page==='rdv')    pageRDV.classList.remove('hidden');
      if(page==='profil') pageProfil.classList.remove('hidden');

      const onAuth = page==='auth';
      navMenu.classList.toggle('hidden', onAuth);
      brandText.classList.toggle('hidden', onAuth);
      badge.classList.toggle('hidden', onAuth || !auth.currentUser);

      const showHeaderLogin = !auth.currentUser && !onAuth;
      loginBtn.classList.toggle('hidden', !showHeaderLogin);
      logoutBtn.classList.toggle('hidden', !auth.currentUser);

      document.getElementById('profil-email').textContent = auth.currentUser?.email || '‚Äî';
    }

    // ===== UI helpers =====
    function notify(msg){
      console.log('Toast:', msg);
      if(!toast) { alert(msg); return; }
      toast.textContent = msg;
      toast.classList.remove('hidden');
      setTimeout(()=>toast.classList.add('hidden'), 3000);
    }
    const emailOk = v => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);

    // ===== Handlers =====
    document.getElementById('signup').addEventListener('click', async ()=>{
      const email = emailEl.value.trim();
      const pass  = passEl.value.trim();
      if(!emailOk(email)) { notify("Email invalide."); return; }
      if(pass.length < 6)  { notify("Mot de passe trop court (min 6)."); return; }
      try{
        const cred = await auth.createUserWithEmailAndPassword(email, pass);
        try{ await cred.user.sendEmailVerification(); } catch(e){ console.warn('sendEmailVerification:', e?.message); }
        notify("V√©rifie ta bo√Æte mail pour activer ton compte.");
        await auth.signOut();             // üîí bloque l‚Äôacc√®s tant que non v√©rifi√©
        location.hash = '#/auth';
      }catch(e){
        console.error('signup:', e);
        if(e.code==='auth/email-already-in-use') notify("Email d√©j√† utilis√©.");
        else if(e.code==='auth/operation-not-allowed') notify("Active la m√©thode Email/Mot de passe dans Firebase.");
        else notify(e.message || "Erreur √† l'inscription.");
      }
    });

    document.getElementById('signin').addEventListener('click', async ()=>{
      const email = emailEl.value.trim();
      const pass  = passEl.value.trim();
      try{
        const cred = await auth.signInWithEmailAndPassword(email, pass);
        if(!cred.user.emailVerified){
          try{ await cred.user.sendEmailVerification(); } catch(e){ console.warn('resend verify:', e?.message); }
          notify("Email non v√©rifi√©. Clique sur le lien re√ßu par email.");
          await auth.signOut();           // üîí reste bloqu√©
          return;
        }
        notify('Connexion r√©ussie'); location.hash = '#/';
      }catch(e){
        console.error('signin:', e);
        if(e.code==='auth/user-not-found') notify("Compte introuvable.");
        else if(e.code==='auth/wrong-password') notify("Mot de passe incorrect.");
        else if(e.code==='auth/unauthorized-domain') notify("Domaine non autoris√© dans Firebase.");
        else if(e.code==='auth/operation-not-allowed') notify("Active la m√©thode Email/Mot de passe dans Firebase.");
        else notify(e.message || "Erreur √† la connexion.");
      }
    });

    logoutBtn.addEventListener('click', async ()=>{
      await auth.signOut(); notify('D√©connect√©'); location.hash = '#/auth';
    });
  </script>
</body>
</html>
