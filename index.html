
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calendrier AN ‚Äî Accueil</title>

<link rel="icon" href="logoalarm-192.png" />
<link rel="manifest" href="manifest.webmanifest" />
<link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <div class="container nav">
      <div class="brand">
        <img src="/logoalarm-192.png" alt="AN">
        <span id="brandText">anassiri.com</span>
        <span id="auth-badge" class="hidden">D√©connect√©</span>
      </div>
      <nav id="navMenu" class="menu">
        <a href="#/" class="btn">Accueil</a>
        <a href="#/rendezvous" class="btn">Rendez-vous</a>
        <a href="#/profil" class="btn">Profil</a>
        <button id="logoutBtn" class="btn danger hidden" type="button">Se d√©connecter</button>
        <a href="#/auth" id="loginBtn" class="btn primary hidden">Se connecter</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- AUTH -->
    <section id="page-auth" class="auth-wrap hidden">
      <div class="auth">
        <img src="/logoalarm-192.png" alt="Logo Calendrier AN" style="width:80px;height:80px;border-radius:16px;margin-bottom:14px;">
        <h1>Cr√©er un compte</h1>
        <p class="subtitle">Inscris-toi puis <strong>v√©rifie ton email</strong> pour activer l‚Äôacc√®s.</p>

        <!-- INSCRIPTION -->
        <form id="form-signup" novalidate>
          <div class="row two">
            <div class="field">
              <label for="first">Pr√©nom</label>
              <input id="first" autocomplete="given-name" placeholder="ex: Adam" />
              <div id="err-first" class="err hidden"></div>
            </div>
            <div class="field">
              <label for="last">Nom</label>
              <input id="last" autocomplete="family-name" placeholder="ex: Nassiri" />
              <div id="err-last" class="err hidden"></div>
            </div>
          </div>

          <div class="field">
            <label for="email">Email</label>
            <input id="email" type="email" placeholder="ex: vous@mail.com" autocomplete="email" />
            <div id="err-email" class="err hidden"></div>
          </div>
          <div class="field">
            <label for="password">Mot de passe</label>
            <input id="password" type="password" placeholder="Au moins 6 caract√®res" autocomplete="new-password" />
            <div id="err-pass" class="err hidden"></div>
          </div>

          <button id="btn-signup" class="btn primary full" type="submit">S‚Äôinscrire</button>
        </form>

        <div class="sep"></div>
        <p class="subtitle">D√©j√† inscrit ?</p>

        <!-- CONNEXION -->
        <form id="form-signin" novalidate>
          <div class="field">
            <label for="email2">Email</label>
            <input id="email2" type="email" placeholder="ex: vous@mail.com" autocomplete="email" />
            <div id="err-email2" class="err hidden"></div>
          </div>
          <div class="field">
            <label for="password2">Mot de passe</label>
            <input id="password2" type="password" placeholder="Votre mot de passe" autocomplete="current-password" />
            <div id="err-pass2" class="err hidden"></div>
          </div>
          <button id="btn-signin" class="btn full" type="submit">Se connecter</button>
        </form>
      </div>
    </section>

    <!-- ACCUEIL -->
    <section id="page-home" class="hidden">
      <div class="card">
        <h2>Bienvenue üëã</h2>
        <p>Tu es connect√©. Voici ton r√©sum√© de rendez-vous.</p>
      </div>
    </section>

    <!-- RDV -->
    <section id="page-rdv" class="hidden">
      <div class="card">
        <h2>Rendez-vous</h2>
        <p class="subtitle">Gestion compl√®te √† venir</p>
      </div>
    </section>

    <!-- PROFIL -->
    <section id="page-profil" class="hidden">
      <div class="card">
        <h2>Profil</h2>
        <p>Nom : <span id="profil-name">‚Äî</span></p>
        <p>Email : <span id="profil-email">‚Äî</span></p>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      ¬© <span id="year"></span> Calendrier AN ‚Äî Tous droits r√©serv√©s
    </div>
  </footer>

  <div id="toast" class="toast hidden"></div>

  <!-- Firebase Compat -->
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-auth-compat.js"></script>

  <script>
    // ===== Helpers UI =====
    const $ = id => document.getElementById(id);
    const emailOk = v => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
    const clean = s => (s||'').trim();
    function setErr(id, msg){ const el=$(id); if(!el) return; el.textContent=msg||''; el.classList.toggle('hidden', !msg); }
    function notify(msg){ const t=$('toast'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 3500); try{console.log(msg);}catch{} }

    window.addEventListener('error', e => { alert('Erreur: '+(e.error?.message||e.message)); });

    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyBfPvC5GtwKvG9TD7cLRo_WlPfifHhxfOU",
      authDomain: "productvues.firebaseapp.com",
      projectId: "productvues",
      storageBucket: "productvues.firebasestorage.app",
      messagingSenderId: "268641672431",
      appId: "1:268641672431:web:a4a5ec6d62fca218c5cf1a"
    };
    if(!window.firebase){ alert('Firebase non charg√©'); }
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});

    // ===== DOM =====
    const pageAuth = $('page-auth'), pageHome=$('page-home'), pageRDV=$('page-rdv'), pageProfil=$('page-profil');
    const navMenu=$('navMenu'), brandText=$('brandText'), badge=$('auth-badge'), logoutBtn=$('logoutBtn');
    $('year').textContent = new Date().getFullYear();

    // ===== Router =====
    const routes = {
      '#/': () => show(auth.currentUser ? 'home' : 'auth'),
      '#/auth': () => show('auth'),
      '#/rendezvous': () => guard(() => show('rdv')),
      '#/profil': () => guard(() => show('profil')),
    };
    function guard(fn){ if(!auth.currentUser){ location.hash='#/auth'; notify('Connecte-toi'); return; } fn(); }
    function route(){ const h=location.hash||'#/'; (routes[h]||routes['#/'])(); }
    auth.onAuthStateChanged(()=>{ route(); });
    window.addEventListener('hashchange', route);

    function show(page){
      [pageAuth,pageHome,pageRDV,pageProfil].forEach(p=>p.classList.add('hidden'));
      if(page==='auth') pageAuth.classList.remove('hidden');
      if(page==='home') pageHome.classList.remove('hidden');
      if(page==='rdv') pageRDV.classList.remove('hidden');
      if(page==='profil') pageProfil.classList.remove('hidden');

      const onAuth = page==='auth';
      navMenu.classList.toggle('hidden', onAuth);
      brandText.classList.toggle('hidden', onAuth);
      badge.classList.toggle('hidden', onAuth || !auth.currentUser);
      logoutBtn.classList.toggle('hidden', !auth.currentUser);

      const u = auth.currentUser;
      $('profil-name').textContent = u?.displayName || '‚Äî';
      $('profil-email').textContent = u?.email || '‚Äî';
    }

    // ===== INSCRIPTION =====
    $('form-signup').addEventListener('submit', async (e)=>{
      e.preventDefault();
      setErr('err-first',''); setErr('err-last',''); setErr('err-email',''); setErr('err-pass','');
      const first = clean($('first').value);
      const last  = clean($('last').value);
      const email = clean($('email').value);
      const pass  = clean($('password').value);

      let ok=true;
      if(!first){ setErr('err-first','Pr√©nom requis'); ok=false; }
      if(!last){ setErr('err-last','Nom requis'); ok=false; }
      if(!emailOk(email)){ setErr('err-email','Email invalide'); ok=false; }
      if(pass.length<6){ setErr('err-pass','Min. 6 caract√®res'); ok=false; }
      if(!ok){ notify('Merci de corriger les champs.'); return; }

      const btn=$('btn-signup'); btn.disabled=true; btn.textContent='Cr√©ation...';
      try{
        const cred = await auth.createUserWithEmailAndPassword(email, pass);
        await cred.user.updateProfile({ displayName: `${first} ${last}` }).catch(()=>{});
        await cred.user.sendEmailVerification().catch(()=>{});
        notify('Compte cr√©√©. V√©rifie ton email pour activer l‚Äôacc√®s.');
        await auth.signOut(); location.hash='#/auth';
      }catch(e){
        console.error('signup', e);
        if(e.code==='auth/email-already-in-use') setErr('err-email','Email d√©j√† utilis√©');
        else if(e.code==='auth/operation-not-allowed') notify('Active la m√©thode Email/Mot de passe dans Firebase.');
        else notify(e.message||'Erreur √† l‚Äôinscription');
        alert(e.message||'Erreur √† l‚Äôinscription');
      }finally{
        btn.disabled=false; btn.textContent='S‚Äôinscrire';
      }
    });

    // ===== CONNEXION =====
    $('form-signin').addEventListener('submit', async (e)=>{
      e.preventDefault();
      setErr('err-email2',''); setErr('err-pass2','');
      const email = clean($('email2').value);
      const pass  = clean($('password2').value);
      let ok=true;
      if(!emailOk(email)){ setErr('err-email2','Email invalide'); ok=false; }
      if(!pass){ setErr('err-pass2','Mot de passe requis'); ok=false; }
      if(!ok){ notify('Merci de corriger les champs.'); return; }

      const btn=$('btn-signin'); btn.disabled=true; btn.textContent='Connexion...';
      try{
        const cred = await auth.signInWithEmailAndPassword(email, pass);
        if(!cred.user.emailVerified){
          try{ await cred.user.sendEmailVerification(); }catch{}
          notify('Email non v√©rifi√©. Clique sur le lien re√ßu par email.');
          await auth.signOut();
          return;
        }
        notify('Connexion r√©ussie'); location.hash = '#/';
      }catch(e){
        console.error('signin', e);
        if(e.code==='auth/user-not-found') setErr('err-email2','Compte introuvable');
        else if(e.code==='auth/wrong-password') setErr('err-pass2','Mot de passe incorrect');
        else if(e.code==='auth/unauthorized-domain') alert("Domaine non autoris√© dans Firebase (Auth > Param√®tres > Domaines autoris√©s).");
        else if(e.code==='auth/operation-not-allowed') alert("Active Email/Mot de passe dans Firebase (Auth > M√©thodes).");
        else alert(e.message||'Erreur √† la connexion');
        notify(e.message||'Erreur √† la connexion');
      }finally{
        btn.disabled=false; btn.textContent='Se connecter';
      }
    });

    // D√©connexion
    $('logoutBtn').addEventListener('click', async ()=>{
      await auth.signOut(); notify('D√©connect√©'); location.hash='#/auth';
    });
  </script>
</body>
</html>
