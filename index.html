<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calendrier Médical</title>

  <link rel="stylesheet" href="style.css" />
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#1976d2">

  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="logoalarm-192.png">

  <link rel="icon" href="logoalarm-192.png" type="image/png">
</head>
<body>

  <!-- En-tête -->
  <header class="topbar">
    <h1>Calendrier Médical</h1>
    <button id="open-signup" class="btn btn-primary" type="button">Créer un compte</button>
  </header>

  <!-- ===== Connexion ===== -->
  <main id="auth" class="auth">
    <div class="card">
      <h2>Connexion</h2>
      <input id="li-email" class="input" type="email" placeholder="Email" autocomplete="email">
      <input id="li-password" class="input" type="password" placeholder="Mot de passe" autocomplete="current-password">
      <button id="btn-login" class="btn btn-fill" type="button">Se connecter</button>
      <p id="auth-error" class="err"></p>
    </div>
  </main>

  <!-- ===== Modale - Création de compte ===== -->
  <div id="signup-modal" class="modal" aria-hidden="true">
    <div class="modal__content">
      <button id="close-signup" class="modal__close" type="button" aria-label="Fermer">&times;</button>
      <h3 class="modal__title">Créer un compte</h3>
      <input id="su-email" class="input" type="email" placeholder="Email (nouveau compte)" autocomplete="email">
      <input id="su-password" class="input" type="password" placeholder="Mot de passe (≥ 6 caractères)" autocomplete="new-password">
      <button id="btn-signup" class="btn btn-fill" type="button">Créer un compte</button>
    </div>
  </div>

  <!-- ===== App ===== -->
  <div id="app" class="app">
    <button id="logoutButton" class="btn" type="button">Se déconnecter</button>
    <button id="stopButton" class="btn danger" type="button" onclick="stopAlarm()" style="display:none">Arrêter l'alarme</button>

    <!-- Alerte -->
    <div id="custom-alert" class="overlay" style="display:none">
      <div class="card" style="max-width:320px">
        <p id="alert-message" style="margin:0 0 10px"></p>
        <button id="closeAlertBtn" class="btn btn-fill" type="button">Fermer</button>
      </div>
    </div>

    <h2 class="section-title">Rappels médicaux</h2>

    <div class="card big">
      <div class="calendar-nav">
        <button type="button" class="btn" onclick="changeMonth(-1)">Mois précédent</button>
        <strong id="month-year"></strong>
        <button type="button" class="btn" onclick="changeMonth(1)">Mois suivant</button>
      </div>

      <div id="calendar" class="calendar"></div>

      <div class="editor">
        <p>Date sélectionnée : <strong id="selected-date">Aucune</strong></p>
        <textarea id="calendar-note" class="input" placeholder="Écrire un rappel pour cette date..."></textarea>

        <!-- step=60 pour minutes entières -->
        <input id="calendar-time" class="input" type="time" step="60">

        <div class="actions">
          <button id="startButton" class="btn" type="button" onclick="startApp()">Continuer</button>
          <!-- IMPORTANT: id=saveButton pour que le JS puisse le cacher/afficher -->
          <button id="saveButton" class="btn btn-fill" type="button" onclick="saveCalendarNote()">Sauvegarder</button>
          <span id="calendar-msg" class="savemsg" style="display:none">Rappel sauvegardé !</span>
        </div>
      </div>
    </div>

    <audio id="alarmSound" src="mario_theme.mp3" preload="auto"></audio>
  </div>

  <!-- ===== Firebase expose auth & db ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getFirestore }  from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBfPvC5GtwKvG9TD7cLRo_WlPfifHhxfOU",
      authDomain: "productvues.firebaseapp.com",
      projectId: "productvues",
      storageBucket: "productvues.firebasestorage.app",
      messagingSenderId: "268641672431",
      appId: "1:268641672431:web:a4a5ec6d62fca218c5cf1a"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // Expose global
    window.auth = auth;
    window.db   = db;
    window.dispatchEvent(new Event('firebase-ready'));

    // Cache le bouton "Créer un compte" si déjà connecté
    const signupBtn   = document.getElementById('open-signup');
    const signupModal = document.getElementById('signup-modal');
    onAuthStateChanged(auth, (user) => {
      if (user) {
        signupBtn.classList.add('hidden');
        if (signupModal.style.display === 'block') {
          signupModal.style.display = 'none';
          signupModal.setAttribute('aria-hidden','true');
        }
      } else {
        signupBtn.classList.remove('hidden');
      }
    });
  </script>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker
        .register('./firebase-messaging-sw.js')
        .catch(err => console.error('SW erreur :', err));
    }
  </script>
<script type="module">
  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-messaging.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  // réutilise les instances exposées par index.html
  const auth = window.auth;
  const db   = window.db;

  // 1) Assure-toi que le SW est prêt
  const reg = await navigator.serviceWorker.ready;

  // 2) Instancie messaging
  const messaging = getMessaging();

  // 3) Quand l’utilisateur est connecté, enregistre le token FCM
  onAuthStateChanged(auth, async (user) => {
    if (!user) return;

    // Demande permission si nécessaire
    if (Notification.permission === "default") {
      await Notification.requestPermission();
    }
    if (Notification.permission !== "granted") return;

    try {
      const token = await getToken(messaging, {
        vapidKey: "BFSgNk48tjDovjdm0D9tVqKpNj80K9ko-8Ljw4cQDibk1n4tml42EQUywI4L26-GWWB_9UcEporrMRx_-9L1m-0",
        serviceWorkerRegistration: reg
      });
      if (token) {
        await setDoc(
          doc(db, "users", user.uid, "fcmTokens", token),
          { active: true, createdAt: serverTimestamp() },
          { merge: true }
        );
        console.log("FCM token enregistré");
      }
    } catch (e) {
      console.warn("FCM getToken error:", e);
    }
  });

  // (optionnel) quand une notif arrive pendant que la page est OUVERTE
  onMessage(messaging, (payload) => {
    console.log("Push reçu en avant-plan:", payload);
  });
</script>
  <!-- App -->
  <script src="scripte.js"></script>
</body>
</html>
